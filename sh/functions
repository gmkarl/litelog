LOGDIR="${LOGDIR:-/var/log/litelog}"
LITELOGDIR="${LITELOGDIR:-/usr/lib/litelog}"
HOSTNAME="${HOSTNAME:-$(hostname)}"
LITELOGDIR="${LITELOGDIR}/sh"
ROTATE_BYTES=$((${ROTATE_BYTES:- 64 * 1024 * 1024 * 1024 }))
TIGHT_SPACE_BYTES=$((${TIGHT_SPACE_BYTES:- ROTATE_BYTES * 3 }))
VIDEO_BACKEND=${VIDEO_BACKEND:-ffmpeg}
VCODEC=${VCODEC:-h264}
AUDIO_BACKEND=${AUDIO_BACKEND:-ffmpeg}
ACODEC=${ACODEC:-opus}

free_bytes() {
  echo $(($(stat --file-system --format="%a * %S" "$LOGDIR")))
}

size_of() {
  stat --format="%s" "$@"
}

space_is_tight() {
  test $(free_bytes) -lt $TIGHT_SPACE_BYTES
}

# true if the two provided files have durations similar within epsilon milliseconds
# Usage: duration_is_same_epsilon <path_one> <path_two> <epsilon>
# also true if path_one has a zero duration, assuming transcoding a damaged file
duration_is_same_epsilon() {
  duration1=$(duration "$1")
  duration2=$(duration "$2")
  epsilon=$(($3))
  delta=$((duration1 - duration2))
  test $duration1 -eq 0 -o \( $delta -ge -$epsilon -a $delta -le $epsilon \) 
}

# make sure space is kept free
ensure_space_free() {
  while space_is_tight
  do
    # for video, deletes an already-compressed file
    ls -d "$LITELOGDIR"/*/free_space.sh | sort -R | {
      read free_space_script
      module=${free_space_script%/*}
      module=${module##*/}
      echo "Drive space is getting tight, asking $module to delete an unneeded file ..."
      /bin/sh "$free_space_script"
    } || for free_space_script in "$LITElOGDIR"/*/free_space.sh
    # in case one free script failed, try all of them
    do
      /bin/sh "$free_space_script" || continue # try next script
      continue 2 # script succeded, check for free space again
    done
    # no scripts succeeded
    # TODO: allow a config setting that starts removing objects from git history
    echo "NO MODULE ABLE TO FREE MORE SPACE"
    return 1
  done
}

. "$LITELOGDIR"/video/${VIDEO_BACKEND}_functions
